<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mini Game 1 - Banana Logic Hunt</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Poppins',system-ui,Arial;
      color:#fff;
      overflow-x:hidden;
      min-height:100vh;
      position:relative;
      background:url("images/Mini%20Game%20Background.png") center/cover no-repeat fixed;
    }
    body::after{
      content:""; position:absolute; inset:0; background:rgba(0,0,0,.25);
    }

    /* NAV – same style as game.html / mini.html */
    .nav{
      position:relative; z-index:3;
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
      padding:12px 20px; background:rgba(247, 191, 89, 0.22); backdrop-filter:blur(2px);
    }
    .lives{display:flex; gap:4px; align-items:center}
    .life{width:50px; height:50px; object-fit:contain}
    .score{text-align:center; font-weight:900; font-size:clamp(1.1rem,2.3vw,1.7rem)}
    .user-actions{display:flex; gap:12px; align-items:center; justify-self:end}
    .username{font-weight:800}
    .logout{
      border:0; cursor:pointer; color:#fff; background:#4b5a2c;
      font-weight:900; padding:10px 16px; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.28);
      transition:transform .12s ease, filter .12s ease;
    }
    .logout:hover{transform:translateY(-1px);filter:brightness(1.05)}

    /* icons under nav */
    .levels-icon,
    .mini-icon{
      position:absolute; z-index:3; top:74px;
      width:66px; height:66px; cursor:pointer;
      transition:transform .15s ease, filter .15s ease;
    }
    .levels-icon{right:22px;}
    .mini-icon{left:22px;}
    .levels-icon:hover,
    .mini-icon:hover{transform:scale(1.08); filter:brightness(1.06)}

    .wrap{
      position:relative; z-index:2;
      min-height:calc(100vh - 100px);
      display:flex; align-items:center; justify-content:center;
      padding:80px 16px 40px;
    }

    .card{
      max-width:520px; width:90%;
      background:rgba(0,0,0,.55);
      border-radius:24px;
      padding:24px 20px 28px;
      box-shadow:0 10px 30px rgba(0,0,0,.4);
      text-align:center;
    }
    .card-title{
      font-size:1.6rem; font-weight:900; margin-bottom:10px;
    }
    .card-sub{
      font-size:.95rem; opacity:.9; margin-bottom:16px;
    }
    .question{
      font-size:1.4rem; font-weight:900; margin:22px 0;
      word-wrap:break-word;
    }
    .answers{
      display:grid;
      grid-template-columns:repeat(2,minmax(120px,1fr));
      gap:14px;
      justify-content:center;
    }
    .btn{
      border:0; cursor:pointer;
      background:#36B24A;
      color:#fff; font-weight:900; font-size:.95rem;
      padding:10px 10px;
      border-radius:20px;
      box-shadow:0 2px 6px rgba(0,0,0,.28);
      transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
      word-wrap:break-word;
    }
    .btn:hover{
      filter:brightness(1.06);
      transform:translateY(-1px);
      box-shadow:0 4px 10px rgba(0,0,0,.35);
    }
    .btn:disabled{
      opacity:.6; cursor:default; transform:none; box-shadow:none;
    }

    .info{margin-top:18px; font-size:.9rem; opacity:.9;}

    /* overlay */
    .overlay{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      z-index:5; background:rgba(0,0,0,.55)
    }
    .panel{
      text-align:center; padding:18px 20px;
      background:rgba(0,0,0,.85);
      border-radius:20px; max-width:420px; width:90%;
      box-shadow:0 10px 28px rgba(0,0,0,.5);
    }
    .alert-img{
      width:min(320px,80vw); height:auto;
      display:block; margin:0 auto 14px;
    }
    .panel p{margin-bottom:16px; font-size:.95rem;}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .cta{
      color:#fff; border:0; cursor:pointer; font-weight:900;
      padding:10px 22px; border-radius:22px;
      box-shadow:0 2px 8px rgba(0,0,0,.3); margin:4px 6px;
    }
    .cta-main{background:#ff9f2c;}
    .cta-alt{background:#36B24A;}

    @media (max-width:600px){
      .answers{grid-template-columns:1fr;}
      .question{font-size:1.25rem;}
    }
  </style>
</head>
<body>
  <audio id="click" src="assets/sounds/click.mp3" preload="auto"></audio>

  <!-- NAV BAR -->
  <nav class="nav">
    <div class="lives" id="lives"></div>
    <div class="score">Score - <span id="score">0</span></div>
    <div class="user-actions">
      <div class="username" id="username">User Name</div>
      <button class="logout" id="logoutBtn">Logout</button>
    </div>
  </nav>

  <!-- icons under nav -->
  <img src="images/Mini%20game%20icon.png" class="mini-icon" alt="Mini Game" onclick="location.href='mini.html'"/>
  <img src="images/Levels%20icon.png" class="levels-icon" alt="Levels" onclick="location.href='levels.html'"/>

  <section class="wrap">
    <div class="card">
      <div class="card-title">Mini Game 1</div>
      <div class="card-sub">
        Answer this quick trivia question correctly to earn <b>+1 life</b> for Banana Logic Hunt.
      </div>
      <div class="question" id="questionText">Loading…</div>
      <div class="answers">
        <button class="btn answer-btn" id="a0" data-index="0">A</button>
        <button class="btn answer-btn" id="a1" data-index="1">B</button>
        <button class="btn answer-btn" id="a2" data-index="2">C</button>
        <button class="btn answer-btn" id="a3" data-index="3">D</button>
      </div>
      <div class="info">Tip: you can only hold up to 3 lives.</div>
    </div>
  </section>

  <div class="overlay" id="overlay">
    <div class="panel" id="panel"></div>
  </div>

<script>
const API_BASE = 'api/';

const $  = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

const clickSfx = $('#click');

let lives = 3;
let score = 0;
let level = 1;
let currentQuestionId = null;

function sfx(){ try{ clickSfx.cloneNode().play(); }catch(e){} }

function renderLives(){
  const box = $('#lives');
  box.innerHTML = '';
  for (let i=0;i<lives;i++){
    const img = document.createElement('img');
    img.src = 'images/Life.png';
    img.alt = 'life';
    img.className = 'life';
    box.appendChild(img);
  }
}

function updateScoreNav(){
  $('#score').textContent = String(score).padStart(2,'0');
}

function setQuestionLoading(){
  $('#questionText').textContent = 'Loading…';
  $$('.answer-btn').forEach((b,i)=>{
    b.textContent = ['A','B','C','D'][i];
    b.disabled = true;
  });
}

function setQuestion(qText, answers){
  $('#questionText').textContent = qText;
  $$('.answer-btn').forEach((b,i)=>{
    const v = answers[i];
    if (v === undefined){
      b.textContent = '-';
      b.disabled = true;
    } else {
      b.textContent = v;
      b.disabled = false;
    }
  });
}

// ---------- overlay ----------
function showOverlay(html){
  $('#panel').innerHTML = html;
  $('#overlay').style.display = 'flex';
}
function hideOverlay(){
  $('#overlay').style.display = 'none';
}

// ---------- user / lives / score ----------
async function loadUser(){
  try{
    const res = await fetch(API_BASE + 'me.php', {cache:'no-store'});
    if (!res.ok){
      location.href = 'auth.html';
      return;
    }
    const data = await res.json();
    if (!data.ok){
      location.href = 'auth.html';
      return;
    }
    const user  = data.user  || {};
    const state = data.state || {};
    $('#username').textContent =
      user.username ||
      user.name     ||
      localStorage.getItem('session_user') ||
      'Player';

    lives = parseInt(state.lives ?? 3);
    score = parseInt(state.score ?? 0);
    level = parseInt(state.current_level ?? 1);

    if (isNaN(lives) || lives < 0) lives = 0;
    if (lives > 3) lives = 3;
    if (isNaN(score) || score < 0) score = 0;

    renderLives();
    updateScoreNav();
  } catch(e){
    console.error('me.php error', e);
    location.href = 'auth.html';
  }
}

// ---------- question from our own PHP (no external API) ----------
async function loadMiniQuestion(){
  setQuestionLoading();
  try{
    const res = await fetch(API_BASE + 'mini1_question.php', {cache:'no-store'});
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(e){
      console.error('mini1_question bad JSON:', text);
      $('#questionText').textContent = 'Server error loading question.';
      return;
    }

    if (!data.ok){
      console.error('mini1_question error:', data);
      $('#questionText').textContent = 'Error loading question.';
      return;
    }

    lives = parseInt(data.lives ?? lives);
    score = parseInt(data.score ?? score);
    level = parseInt(data.level ?? level);

    if (isNaN(lives) || lives < 0) lives = 0;
    if (lives > 3) lives = 3;
    if (isNaN(score) || score < 0) score = 0;

    currentQuestionId = data.questionId;

    renderLives();
    updateScoreNav();

    setQuestion(data.questionText, data.answers || []);
  } catch(e){
    console.error('mini1_question network error', e);
    $('#questionText').textContent = 'Server error loading question.';
  }
}

// ---------- submit answer ----------
async function submitAnswer(answerIndex){
  if (currentQuestionId == null) return;

  sfx();
  $$('.answer-btn').forEach(b => b.disabled = true);

  try{
    const res  = await fetch(API_BASE + 'mini1_check.php', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        questionId: currentQuestionId,
        answerIndex: answerIndex
      })
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(e){
      console.error('mini1_check bad JSON:', text);
      alert('Server error checking answer.');
      await loadMiniQuestion();
      return;
    }

    if (!data.ok){
      console.error('mini1_check error:', data);
      alert('Server error checking answer.');
      await loadMiniQuestion();
      return;
    }

    lives = parseInt(data.lives ?? lives);
    score = parseInt(data.score ?? score);
    level = parseInt(data.level ?? level);

    if (isNaN(lives) || lives < 0) lives = 0;
    if (lives > 3) lives = 3;
    if (isNaN(score) || score < 0) score = 0;

    renderLives();
    updateScoreNav();

    if (data.result === 'correct'){
      const textMsg = data.wonLife
        ? 'You earned +1 life! (Max 3 lives).'
        : 'Correct! You already have the maximum 3 lives.';
      showOverlay(`
        <img class="alert-img" src="images/Earned%20life.png" alt="Earned life">
        <p>${textMsg}</p>
        <div class="row">
          <button class="cta cta-main" id="goMain">Main Game</button>
          <button class="cta cta-alt"  id="playAgain">Play Again</button>
        </div>
      `);
      $('#goMain').onclick    = () => { location.href = 'game.html'; };
      $('#playAgain').onclick = async () => { hideOverlay(); await loadMiniQuestion(); };
    } else {
      showOverlay(`
        <img class="alert-img" src="images/Answer%20is%20wrong.png" alt="Wrong">
        <p>Oops! That wasn’t correct. Try another question?</p>
        <div class="row">
          <button class="cta cta-alt"  id="retry">Try Again</button>
          <button class="cta cta-main" id="back">Back</button>
        </div>
      `);
      $('#retry').onclick = async () => { hideOverlay(); await loadMiniQuestion(); };
      $('#back').onclick  = () => { location.href = 'levels.html'; };
    }
  } catch(e){
    console.error('mini1_check network error', e);
    alert('Network error checking answer.');
    await loadMiniQuestion();
  }
}

// ---------- events ----------
$('#logoutBtn').addEventListener('click', async () => {
  sfx();
  try{ await fetch(API_BASE + 'logout.php', {method:'POST'}); } catch(e){}
  localStorage.removeItem('session_user');
  location.href = 'auth.html';
});

$$('.answer-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const idx = parseInt(btn.dataset.index, 10);
    if (Number.isNaN(idx)) return;
    submitAnswer(idx);
  });
});

// ---------- init ----------
(async function init(){
  await loadUser();
  await loadMiniQuestion();
})();
</script>
</body>
</html>
